#!/usr/bin/env bash
set -euo pipefail

# --- Helpers ---
repo_root="$(git rev-parse --show-toplevel)"
cd "$repo_root"

# Détecter l'OS (Git Bash sous Windows retourne souvent 'MINGW*')
unameOut="$(uname -s || echo unknown)"
case "${unameOut}" in
    Linux*)     os=linux;;
    Darwin*)    os=mac;;         # si jamais
    MINGW*|MSYS*) os=windows;;
    *)          os=other;;
esac

echo "[pre-push] Detected OS: $os"

# --- Choix des presets selon l'OS ---
if [[ "$os" == "windows" ]]; then
  CONFIG_PRESET="win-msvc-tests"     # configure avec tests ON
  BUILD_PRESET="win-tests-build"     # build Debug
  TEST_PRESET="win-tests"            # ctest Debug
  CTEST_EXTRA=""                     # sous Windows, pas besoin de -C Debug via preset
else
  CONFIG_PRESET="dev-linux"
  BUILD_PRESET="dev-build"
  TEST_PRESET="dev-tests"
  CTEST_EXTRA=""                     # déjà Debug via preset
fi

# --- (Optionnel) Ne lancer que si des fichiers C++/CMake ont changé dans ce push ---
# Si tu veux vraiment économiser chaque ms, décommente et adapte :
# changed=$(git diff --name-only --cached || true)
# if ! echo "$changed" | grep -Eq '(\.cpp$|\.hpp$|\.h$|CMakeLists\.txt|CMakePresets\.json|^Client/|^Server/|^tests/)'; then
#   echo "[pre-push] No relevant changes (C++/CMake/tests). Skipping tests."
#   exit 0
# fi

echo "[pre-push] Configuring with preset: $CONFIG_PRESET"
cmake --preset="$CONFIG_PRESET"

echo "[pre-push] Building tests with preset: $BUILD_PRESET"
cmake --build --preset="$BUILD_PRESET" --target rtype_tests -j4

echo "[pre-push] Running tests with preset: $TEST_PRESET"
# Pour n'exécuter QUE les tests rapides taggués [fast], décommente la ligne suivante
# ctest --preset="$TEST_PRESET" --output-on-failure -R fast
ctest --preset="$TEST_PRESET" --output-on-failure $CTEST_EXTRA

echo "[pre-push] Tests passed. Proceeding with push."
exit 0
