name: CI/CD Pipeline

on:
  pull_request:
    branches: [ main, master, develop, Client-Network ]
    types: [opened, synchronize, reopened]
  push:
    branches: [ main, master, develop ]

env:
  CPM_SOURCE_CACHE: ${{ github.workspace }}/.cache/CPM

jobs:
  style-check:
    name: Code Style Check
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        # Fetch full history for proper diff detection
        fetch-depth: 0

    - name: Run clang-format style check
      uses: jidicula/clang-format-action@v4.13.0
      with:
        clang-format-version: '19'
        check-path: '.'
        exclude-regex: 'build.*|\.cache.*|cpm_cache.*'
        fallback-style: 'LLVM'
  build-and-test-linux:
    name: Build & Test (Linux)
    runs-on: ubuntu-latest
    needs: style-check
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    - name: Setup CPM Cache
      uses: actions/cache@v4
      with:
        path: .cache/CPM
        key: ${{ runner.os }}-cpm-${{ hashFiles('**/CMakeLists.txt') }}
        restore-keys: |
          ${{ runner.os }}-cpm-
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          cmake \
          ninja-build \
          libgl1-mesa-dev \
          libxrandr-dev \
          libxinerama-dev \
          libxcursor-dev \
          libxi-dev \
          libudev-dev \
          libfreetype6-dev \
          libopenal-dev \
          libflac-dev \
          libvorbis-dev \
          libsfml-dev
    - name: Configure CMake (Debug with Tests)
      run: cmake --preset linux-config-dev
    - name: Build
      run: cmake --build --preset linux-build-dev
    - name: Run Unit Tests
      run: |
        cd build/dev
        echo "Running unit tests..."
        ctest --verbose --output-on-failure
    - name: Upload test results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: test-results-linux
        path: |
          build/dev/Testing/Temporary/LastTest.log
          build/dev/Testing/Temporary/LastTestsFailed.log
        retention-days: 7
  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    - name: Run CodeQL Analysis
      uses: github/codeql-action/init@v3
      with:
        languages: cpp
    - name: Install dependencies for build
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          cmake \
          ninja-build \
          libgl1-mesa-dev \
          libxrandr-dev \
          libxinerama-dev \
          libxcursor-dev \
          libxi-dev \
          libudev-dev \
          libfreetype6-dev \
          libopenal-dev \
          libflac-dev \
          libvorbis-dev \
          libsfml-dev
    - name: Build for analysis
      run: |
        cmake --preset linux-config-dev
        cmake --build --preset linux-build-dev
    - name: Perform CodeQL Analysis
      uses: github/codeql-action/analyze@v3
  mirror-to-epitech:
    name: Mirror to Epitech Repository
    runs-on: ubuntu-latest
    needs: [style-check, build-and-test-linux]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    - name: Push to mirror repository
      run: |
        git remote add mirror https://x-access-token:${{ secrets.MIRROR_TOKEN_2 }}@github.com/EpitechPGE3-2025/G-CPP-500-PAR-5-1-rtype-2.git
        git push mirror --mirror
  report-status:
    name: Report Overall Status
    runs-on: ubuntu-latest
    needs: [style-check, build-and-test-linux]
    if: always()
    steps:
    - name: Check job results
      run: |
        echo "Style Check: ${{ needs.style-check.result }}"
        echo "Linux Build & Test: ${{ needs.build-and-test-linux.result }}"
        if [[ "${{ needs.style-check.result }}" != "success" ]] || \
           [[ "${{ needs.build-and-test-linux.result }}" != "success" ]]; then
          echo "[FAIL] CI pipeline failed!"
          exit 1
        else
          echo "[OK] All checks passed!"
        fi